#!/usr/bin/env bash

# requires debian packages:
#  - suckless-tools (for dmenu) or rofi
#  - xdotool
#  - gopass (or pass)

shopt -s nullglob globstar

typeit=0
pass_opts=()

for arg in "$@"
do
    case $arg in
        --type)
        typeit=1
        shift
        ;;
        --username)
        pass_opts+=("--username")
        shift
        ;;
        *)
        ;;
    esac
done


prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "${prefix}"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

password=$(printf '%s\n' "${password_files[@]}" | rofi -dmenu "$@")

[[ -n ${password} ]] || exit

case "${typeit}${WAYLAND_DISPLAY+w}" in
	0)
        pass show ${pass_opts} "${password}" | awk 'BEGIN{ORS=""} {print; exit}' | xclip -sel clip
        ;;
	0w)
        pass show ${pass_opts} "${password}" | awk 'BEGIN{ORS=""} {print; exit}' | wl-copy
        ;;
	1)
        pass show ${pass_opts} "${password}" | awk 'BEGIN{ORS=""} {print; exit}' | xdotool type --clearmodifiers --file -
        ;;
	1w)
        pass show ${pass_opts} "${password}" | awk 'BEGIN{ORS=""} {print; exit}' | sudo ydotool type --file -
        ;;
esac
